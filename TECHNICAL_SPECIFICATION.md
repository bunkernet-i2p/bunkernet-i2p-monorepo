# ТЕХНИЧЕСКОЕ ЗАДАНИЕ: «BUNKERNET-I2P» — ДЕЦЕНТРАЛИЗОВАННАЯ СОЦСЕТЬ НА XMPP

## 1. ВИДЕНИЕ: VK.COM + ACTIVITYPUB, НАДЕТЫЕ НА XMPP
Цель — создать **полноценную децентрализованную социальную сеть**, где каждый сервер («бункер») является автономным узлом, а взаимодействие между узлами происходит через расширенный XMPP. Пользователь получает опыт, похожий на старый VK: профиль, стена с постами, комментарии, лайки, группы, личные сообщения — но в изолированных, контролируемых сообществах.

## 2. ФУНДАМЕНТАЛЬНЫЕ ПРИНЦИПЫ АРХИТЕКТУРЫ
*   **XMPP как транспорт и бэкбон:** Все сущности и действия моделируются через XMPP и его расширения (XEP).
*   **PubSub (XEP-0060) как ядро социальности:** Профили, ленты пользователей, ленты групп, комментарии, реакции — всё это узлы (nodes) PubSub, на которые можно подписаться.
*   **Сервер-бункер как доверенный хаб:** Сервер (ejabberd/Prosody) хранит данные своих пользователей, обеспечивает федерацию с другими доверенными серверами, управляет подписками и доставкой событий.
*   **Клиент как толстый просмотрщик и агрегатор:** Клиент не просто отображает чат. Он **агрегирует данные из множества PubSub-подписок** (лента друзей, уведомления) и предоставляет единый социальный интерфейс.

## 3. КЛЮЧЕВЫЕ СУЩНОСТИ И ИХ РЕАЛИЗАЦИЯ

### 3.1. Бункер (Bunker Server)
*   **Роль:** Автономный узел сети. Домен (например, `bunker-network.org`).
*   **Состав:** Экземпляр XMPP-сервера с обязательными модулями: `mod_pubsub` (Persistent), `mod_pep` (Personal Eventing), `mod_muc`, `mod_muc_sub`, `mod_http_upload`, `mod_vcard`.
*   **Политика:** Изоляция по умолчанию. Федерация (s2s) возможна только с явно указанными в белом списке доменами других бункеров.

### 3.2. Пользователь (Citizen)
*   **Идентификатор:** Полный JID (`username@bunker-network.org`).
*   **Профиль:** `vCard` (аватар, статус, "о себе").
*   **Персональная лента (PEP):** Узел `urn:xmpp:microblog:0`. Каждый пост — публикация в этот узел. Автоматически рассылается всем подписчикам из ростера.

### 3.3. Запись (Post)
*   **Содержимое:** Форматированный текст, вложения (ссылки на файлы через HTTP Upload), метаданные (дата, язык).
*   **Хранение:** Item в PubSub-узле автора (для поста на стене) или группы (для поста в сообществе).
*   **Формат:** XML-полезная нагрузка, соответствующая **XEP-0277 (Microblogging)** или собственному пространству имён `urn:bunkernet:post`.

### 3.4. Сообщество (Group / Public Realm)
*   **Реализация:** **MUC-комната (XEP-0045)** с дополнительными функциями.
*   **Особенности:** Постоянная (`persistent`), с открытой или закрытой подпиской. Имеет свой **PubSub-узел для ленты записей** (XEP-0045 + `mod_muc_sub` для подписки на события).
*   **Администрирование:** Владельцы и модераторы комнаты.

### 3.5. Социальные взаимодействия
*   **Подписка (Following):** Добавление JID в ростер + подписка на его PEP-узел (`urn:xmpp:microblog:0`).
*   **Комментарий (Comment):** Item в **отдельном PubSub-узле, привязанном к ID поста** (например, `comments:post-123`).
*   **Реакция (Like):** Использование **XEP-0444 (Reactions)** или отдельный PubSub-узел реакций.
*   **Уведомление (Notification):** Сервер генерирует сообщение или публикацию в личный узел уведомлений пользователя при событиях (новый комментарий, реакция, упоминание).

## 4. ПОТОК ДАННЫХ: КАК РАБОТАЕТ ЛЕНТА
1.  **Пользователь А** публикует пост. Его клиент отправляет `<pubsub><publish node='urn:xmpp:microblog:0'>` на его сервер.
2.  **Сервер пользователя А** сохраняет пост и, благодаря модулю PEP, автоматически рассылает уведомление о новой публикации **всем подписчикам из ростера А**, которые находятся на том же или на доверенных серверах.
3.  **Пользователь Б (подписчик)** получает это уведомление от своего сервера.
4.  **Клиент пользователя Б**, получив уведомление, **запрашивает полные данные поста** с сервера А (или из кэша).
5.  **Клиент Б** агрегирует это событие в свою общую ленту, которая состоит из событий со всех его подписок.

## 5. КЛИЕНТ (QUASER PWA): НОВЫЕ ЗАДАЧИ
Клиент теперь должен быть не чатом, а **социальным агрегатором**:
1.  **Менеджер подписок:** Отображать не только чаты, но и список подписок (друзей, групп), их статусы, новые посты.
2.  **Лента агрегации:** Главный экран — единая хронологическая лента, куда стекаются посты из всех PubSub-подписок пользователя.
3.  **Комплексный просмотр поста:** Экран поста должен отображать сам пост, ленту комментариев (подгружаемую из отдельного PubSub-узла), реакции.
4.  **Богатый редактор:** Создание постов с текстовым форматированием, прикреплением файлов, упоминаниями других пользователей (`@username@server`).

## 6. ПУТЬ К I2P И QT
Архитектура не меняется:
*   **I2P:** XMPP-сервер настраивается как hidden service. Клиент подключается к нему через SOCKS5-прокси i2p-роутера.
*   **Qt:** Бизнес-логика клиента (работа с XMPP, агрегация ленты) выделяется в отдельный слой, который позже портируется на C++/Qt.

---
*Мы строим не чат и не форум. Мы строим **скелет децентрализованной социальной вселенной**, где XMPP — это нервная система, PubSub — кости и суставы, а клиент — кожа и лицо.*
