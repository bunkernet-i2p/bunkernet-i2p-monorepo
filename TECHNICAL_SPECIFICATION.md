# ТЕХНИЧЕСКОЕ ЗАДАНИЕ: «BUNKER-NET» — СЕТЬ НЕЗАВИСИМЫХ СЕРВЕРОВ-УБЕЖИЩ

## 1. НОВАЯ АРХИТЕКТУРА: ФЕДЕРАТИВНАЯ СЕТЬ
Система состоит из множества независимых **Bunker Servers** (серверов-убежищ), к которым подключаются клиенты.
*   **Любой пользователь может запустить свой Bunker Server** на своём VPS, домашнем сервере или даже на локальной машине (с пробросом портов). Это его **личное или групповое убежище**.
*   **Клиент (Quasar PWA)** умеет подключаться к **любому из этих серверов**, указав его адрес (URL). У одного пользователя в клиенте может быть несколько подключений к разным серверам.
*   **Нет центрального реестра или главного сервера.** Обнаружение серверов происходит через социальные связи: пользователь A, запустивший сервер, отправляет **пригласительную ссылку** (URL своего сервера + токен доступа) пользователю B.

## 2. КЛЮЧЕВЫЕ СУЩНОСТИ И ИХ ЖИЗНЕННЫЙ ЦИКЛ

### 2.1. Bunker Server (Сервер-Убежище)
*   **Самостоятельный экземпляр:** Полнофункциональный сервер (Node.js + Express + Socket.io + SQLite) с API, описанным ранее.
*   **Идентификация:** Его уникальный ID — это **публичный URL**, по которому он доступен (например, `https://bunker.mydomain.com` или `http://192.168.1.100:3000`).
*   **Администрирование:** При первом запуске генерируется **административный ключ (adminToken)**. С его помощью можно создавать комнаты (ProtectedLivelyRealm) и инвайты.
*   **Изоляция:** Данные (сообщения, файлы, пользователи) одного сервера **полностью изолированы** от данных другого. Это разные цифровые бункера.

### 2.2. ProtectedLivelyRealm (Комната внутри Убежища)
*   **Принадлежность:** Создаётся и существует на **конкретном Bunker Server**. Комнаты с одного сервера не видны на другом.
*   **Инвайт:** Ссылка-приглашение в комнату теперь содержит **адрес сервера и токен комнаты** на этом сервере (например, `https://bunker.mydomain.com/#/invite/abc123`).

### 2.3. Клиент (Quasar PWA)
*   **Мультисерверность:** Ведёт список подключённых серверов. Для каждого сервера хранит его URL и локальный никнейм, использованный на нём.
*   **Универсальность:** Один и тот же клиент может использоваться для подключения к любым серверам, совместимым с API Bunker Server.

## 3. ТЕХНИЧЕСКИЕ ИЗМЕНЕНИЯ ДЛЯ РЕАЛИЗАЦИИ

### 3.1. Изменения в API сервера
*   **Базовая проверка:** Сервер должен отдавать простой endpoint для проверки (`GET /api/info`), возвращающий тип приложения и версию API.
*   **Отказ от глобальной идентификации:** Так как серверы независимы, нет нужды в глобальных уникальных ID пользователей. **Идентификатор пользователя — это пара `(server_url, nickname)`**. На каждом сервере nickname может быть занят другим человеком — это нормально в рамках изолированного бункера.

### 3.2. Изменения в клиенте
*   **Менеджер подключений:** Нужен новый сервис `services/server-manager.js` и хранилище Pinia `serversStore`. Он отвечает за:
    *   Добавление нового сервера (ввод URL).
    *   Тестирование подключения к нему (запрос к `/api/info`).
    *   Сохранение списка серверов и профиля (nickname) для каждого в `localStorage`.
*   **Динамическая конфигурация API и WebSocket:** Сетевые запросы (Axios, Socket.io) должны динамически формировать базовый URL, исходя из **текущего выбранного сервера**.

## 4. ПОТОК РАБОТЫ ПОЛЬЗОВАТЕЛЯ (ДЕЦЕНТРАЛИЗОВАННЫЙ)

1.  **Запуск сервера (Администратор):**
    *   Пользователь A разворачивает на своём хостинге Bunker Server (по инструкции из `DEPLOY.md`).
    *   Получает URL своего сервера и административный токен.

2.  **Подключение к серверу и создание комнаты (Администратор в клиенте):**
    *   В клиенте пользователь A добавляет свой сервер (вводит URL).
    *   Создаёт новую комнату (Realm) на этом сервере (через API с `adminToken` или через первый вход как создатель).
    *   Клиент генерирует **пригласительную ссылку**, включающую URL сервера и токен комнаты.

3.  **Присоединение нового участника (Пользователь B):**
    *   Пользователь B получает пригласительную ссылку.
    *   При переходе по ссылке клиент B **распознаёт URL сервера**, предлагает ввести никнейм и подключается к указанному серверу, используя токен из ссылки.
    *   Клиент B сохраняет этот сервер в свой список, и комната появляется в его интерфейсе.

4.  **Работа в сети:**
    *   Пользователь может одновременно быть участником комнат на нескольких разных серверах (например, «Семейный бункер» на своём сервере и «Проект Х» на сервере коллеги).

## 5. ПЛАН РАЗВИТИЯ: I2P И QT

Эта архитектура **идеально подходит для интеграции с i2p**:
*   **Bunker Server** может быть запущен как **i2p hidden service (eepsite)**. Его адресом будет `.b32.i2p`-строка.
*   **Пригласительные ссылки** будут содержать i2p-адреса.
*   **Клиент** для работы с i2p-сетью будет нуждаться в i2p-роутере (например, встроенном через `i2pd`).

**Портирование на Qt:** Не меняется. Логика менеджера серверов и мультисерверность переходят в нативное приложение.

---
*Мы строим не платформу, а **клиент для сети автономных бункеров**. Каждый бункер — это суверенная территория своего владельца. Клиент — это паспорт, позволяющий посещать разные такие территории.*
