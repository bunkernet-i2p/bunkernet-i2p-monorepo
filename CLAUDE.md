# CLAUDE.md — ИНСТРУКЦИИ ДЛЯ МУЛЬТИСЕРВЕРНОГО «BUNKER-NET»

## ЦЕЛЬ
Создать **клиент, который работает с множеством независимых серверов (Bunker Servers)**, и **шаблон сервера, который любой может развернуть**.

## ИЗМЕНЕНИЯ В ПОДХОДЕ
1.  **Сервер (`/server/`)** становится **типовым, шаблонным проектом**. Его код должен быть готов к развёртыванию кем угодно.
2.  **Клиент (`/` или `/client/`)** должен уметь **добавлять, переключать и работать с несколькими серверами**.

## ПЛАН РАЗРАБОТКИ

### ЭТАП 0: ШАБЛОННЫЙ BUNKER SERVER (2-3 ДНЯ) [ОБНОВЛЁН]
**Цель: Создать сервер, который можно клонировать и запустить одной командой.**

1.  **Создай директорию `/server` с полной, работающей реализацией из прошлого ТЗ (API, WebSocket, SQLite).**
2.  **Добавь эндпоинт для проверки (`server/routes/info.js`):**
    ```javascript
    // GET /api/info
    router.get('/', (req, res) => {
      res.json({
        app: 'BunkerNet-Server',
        version: '0.1.0',
        vendor: 'Fairytale-of-Fairytales'
      });
    });
    ```
3.  **Упрости модель данных:** Убери концепцию «глобального пользователя». В таблице `realm_members` и `messages` достаточно поля `nickname` (текст). **Администратор — это просто первый создатель комнаты.**
4.  **Создай исчерпывающий `DEPLOY.md`** внутри `/server`, описывающий развёртывание:
    *   Через `docker run` (собери Dockerfile).
    *   Через `npm install && npm start` на VPS.
    *   Как получить внешний URL и настроить HTTPS (например, через Caddy или Nginx).

### ЭТАП 1: КЛИЕНТ — МЕНЕДЖЕР ПОДКЛЮЧЕНИЙ К СЕРВЕРАМ (3-4 ДНЯ) [НОВОЕ!]
**Это ключевая новая функциональность.**

1.  **Создай хранилище `serversStore` (`stores/servers-store.js`):**
    ```javascript
    state: () => ({
        servers: [ // Массив подключённых серверов
            {
                id: 'uuid', // Локальный ID для ключей Vue
                url: 'https://bunker.example.com', // Базовый URL сервера
                nickname: 'MyNickOnThisServer', // Мой ник на ЭТОМ сервере
                isConnected: false // Флаг успешной проверки /api/info
            }
        ],
        activeServerId: null // ID текущего выбранного сервера
    }),
    actions: {
        async addServer({ url, nickname }) { ... },
        removeServer(serverId) { ... },
        setActiveServer(serverId) { ... },
        async testServerConnection(serverUrl) { ... } // Вызывает GET /api/info
    }
    ```
2.  **Создай сервис-обёртку для API (`services/bunker-api.js`):**
    *   Он должен **динамически брать базовый URL из `activeServer`** в `serversStore`.
    *   Все вызовы API (`createRealm`, `joinRealm`, `getMessages`) должны идти через этот сервис.
    ```javascript
    import { serversStore } from '@/stores/servers-store';
    import axios from 'axios';

    export function getApiClient() {
        const activeServer = serversStore.activeServer;
        if (!activeServer) throw new Error('No active server');
        return axios.create({ baseURL: activeServer.url + '/api' });
    }

    export const api = {
        async createRealm(data) {
            const client = getApiClient();
            return client.post('/realms', data);
        }
        // ... остальные методы
    };
    ```
3.  **Создай аналогичный сервис для WebSocket (`services/bunker-socket.js`):**
    *   Он должен уметь переподключаться при смене `activeServer`.

### ЭТАП 2: КЛИЕНТ — ОБНОВЛЁННЫЙ ИНТЕРФЕЙС (3 ДНЯ)
1.  **Главный экран (`HomePage.vue`):**
    *   **Левая панель (навигация):** Список серверов из `serversStore`. Возле каждого — индикатор подключения (`isConnected`). Возможность добавить новый сервер (модальное окно).
    *   **Центральная панель:** При выборе сервера в навигации — отображает список комнат (Realms) **этого конкретного сервера**.
2.  **Модальное окно «Добавить сервер»:** Поля:
    *   `Server URL` (обязательное, с валидацией и вызовом `testServerConnection`).
    *   `My Nickname on this server` (обязательное).
    *   Кнопка «Save». При сохранении вызывает `serversStore.addServer()`.
3.  **Обработка пригласительных ссылок:**
    *   Ссылка имеет формат: `{SERVER_URL}#/invite/{INVITE_TOKEN}`.
    *   При переходе по такой ссылке приложение должно:
        1.  Извлечь `SERVER_URL` и `INVITE_TOKEN`.
        2.  Проверить, есть ли такой сервер в `serversStore`.
        3.  Если нет — предложить добавить его (предзаполнив URL и запросив nickname).
        4.  После добавления/выбора сервера автоматически вызвать API для присоединения к комнате с этим `INVITE_TOKEN`.

### ЭТАП 3: ИНТЕГРАЦИЯ И ТЕСТИРОВАНИЕ (2 ДНЯ)
1.  **Протестируй сценарий с двумя серверами:**
    *   Запусти **два экземпляра сервера** на разных портах локально (`http://localhost:3001`, `http://localhost:3002`).
    *   В клиенте добавь оба сервера с разными никами.
    *   Создай комнату на первом сервере, пригласи пользователя на втором сервере.
    *   Убедись, что чат работает внутри комнаты, и данные **не смешиваются** между серверами.
2.  **Обнови документацию:** В `README.md` клиента чётко объясни: «Это клиент для сети BunkerNet. Вам нужен адрес сервера. Вы можете развернуть свой сервер, следуя инструкциям в `/server/DEPLOY.md`».

## КРИТИЧЕСКИЕ МОМЕНТЫ РЕАЛИЗАЦИИ
*   **CORS:** Сервер должен быть сконфигурирован для работы с клиентом с любого origin (`Access-Control-Allow-Origin: *`), так как клиент может хоститься отдельно. Для продакшена — более строгие настройки.
*   **Хранение токенов:** Административный токен или токены сессий (если добавится авторизация) должны храниться в клиенте **привязанными к конкретному серверу**.
*   **Универсальность клиента:** Клиент не должен содержать жёстко зашитых URL, кроме, возможно, ссылки на репозиторий с шаблоном сервера.

## ЦЕЛЬ MVP (МУЛЬТИСЕРВЕРНАЯ)
**Два человека должны иметь возможность:**
1.  Каждый развернуть **свой собственный экземпляр Bunker Server** (хоть на localhost с разными портами).
2.  Подключиться в клиенте **к своему собственному серверу**.
3.  Один из них создать комнату на своём сервере и отправить пригласительную ссылку (с URL своего сервера) другому.
4.  Второй человек **добавить этот чужой сервер в свой клиент** и присоединиться к комнате.
5.  Вести общий чат в этой комнате, **данные которой физически находятся на сервере первого человека**.

**Это будет прототип настоящей децентрализованной сети бомбоубежищ.**
