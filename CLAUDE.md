# CLAUDE.md — ИНСТРУКЦИИ ДЛЯ СОЦИАЛЬНОЙ СЕТИ BUNKERNET НА XMPP

## НОВЫЙ МАСШТАБ
Ты строишь не чат. Ты строишь **клиент для децентрализованной социальной сети на XMPP**, использующий PubSub (XEP-0060) и PEP (XEP-0163) как основу для лент, постов и взаимодействий.

## СТЕК И БИБЛИОТЕКИ (ОБНОВЛЁННЫЙ)

### Для Сервера (Образ "Бункера")
*   **Сервер:** **Ejabberd** (рекомендуется из-за мощной реализации `mod_pubsub` и `mod_pep`).
*   **Обязательные модули:** `mod_pubsub`, `mod_pep`, `mod_muc`, `mod_muc_sub`, `mod_vcard`, `mod_http_upload`, `mod_roster`.
*   **Конфигурация:** Нужно настроить `mod_pubsub` для персистентности, `mod_pep` для автоматической рассылки.

### Для Клиента (Quasar PWA)
*   **XMPP Core:** `stanza.io` (как и раньше).
*   **Работа с PubSub:** Тебе придётся реализовать логику поверх `stanza.io`, так как для PubSub нужны специфические IQ-запросы (`<pubsub>`). Это основная сложность.
*   **Управление состоянием:** Pinia. Структура состояния усложняется:
    ```javascript
    // stores/social-store.js
    state: () => ({
        feeds: { // Ленты: home, notifications, per-user, per-group
            'home': [{/* aggregated post object */}],
            'notifications': [...]
        },
        subscriptions: [], // Список подписок (JID + node)
        currentPost: null // Полные данные открытого поста + комментарии
    })
    ```
*   **UI-библиотеки:** Для ленты как у соцсети могут понадобиться виртуализированные списки (`vue-virtual-scroller`).

## ПЛАН РАЗРАБОТКИ (MVP СОЦИАЛЬНОЙ ФУНКЦИОНАЛЬНОСТИ)

### ЭТАП 0: СЕРВЕР — НАСТРОЙКА EJABBERD С PUBSUB/PEP (2-3 ДНЯ)
**Цель: Получить работающий сервер, на котором можно тестировать социальные функции.**
1.  **Создай Docker-образ на базе ejabberd/ecs.** Добавь конфигурационный файл `ejabberd.yml`.
2.  **Активируй и настрой ключевые модули в `ejabberd.yml`:**
    ```yaml
    modules:
      mod_pubsub:
        access_createnode: pubsub_createnode
        # Упрощаем: позволяем всем создавать узлы
        plugins: ["flat", "hometree", "pep"]
        force_node_config: []
      mod_pep: {}
      mod_muc: {}
      mod_muc_sub: {}
    ```
3.  **Напиши скрипт инициализации,** который при первом запуске создаёт тестовых пользователей (`admin@bunker.example`, `user1@bunker.example`).

### ЭТАП 1: КЛИЕНТ — БАЗОВЫЙ PUBSUB + СОЗДАНИЕ ПОСТА (4-5 ДНЕЙ)
**Цель: Научиться публиковать пост в свою личную ленту (PEP-узел).**
1.  **Создай сервис для работы с PubSub (`services/pubsub-service.js`).** Основные методы:
    ```javascript
    export class PubSubService {
        // Создать узел (если не существует)
        async createNode(client, node, config) { /* IQ set <pubsub><create/> */ }
        // Опубликовать item в узел
        async publish(client, node, itemId, payload) { /* IQ set <pubsub><publish/> */ }
        // Подписаться на узел
        async subscribe(client, node, jid) { /* IQ set <pubsub><subscribe/> */ }
        // Получить items из узла
        async getItems(client, node, maxItems) { /* IQ get <pubsub><items/> */ }
    }
    ```
2.  **Интегрируй с XMPP-сервисом.** После входа пользователя, инициируй:
    *   Подписку на свой собственный PEP-узел `urn:xmpp:microblog:0` (чтобы получать свои же посты? обычно это не нужно, но для теста).
    *   Проверку, что узел существует, или его создание.
3.  **Создай компонент `CreatePost.vue`:** Форма с полем ввода (можно простой текст) и кнопкой «Опубликовать».
    *   По нажатию: `pubsubService.publish(client, 'urn:xmpp:microblog:0', 'post_' + Date.now(), { type: 'post', content: text })`.

### ЭТАП 2: КЛИЕНТ — ПОДПИСКИ И ЛЕНТА (HOME FEED) (5-6 ДНЕЙ)
**Цель: Подписаться на другого пользователя и видеть его посты в своей ленте.**
1.  **Расширь `pubsub-service`:** Добавь метод для получения списка подписок и их узлов.
2.  **Реализуй логику подписки на пользователя:**
    *   UI: Поле для ввода JID друга и кнопка «Подписаться».
    *   По нажатию: 1) Добавить JID в ростер (`<presence type='subscribe'/>`), 2) После подтверждения подписки — вызвать `pubsubService.subscribe()` на его PEP-узел `urn:xmpp:microblog:0`.
3.  **Реализуй агрегатор ленты:**
    *   Создай фоновый процесс, который периодически опрашивает (или слушает уведомления от сервера) **все PubSub-узлы, на которые подписан пользователь**.
    *   Полученные items (посты) сохраняй в хранилище Pinia `socialStore.feeds['home']`, сортируя по времени.
    *   Создай компонент `HomeFeed.vue`, который отображает этот массив.

### ЭТАП 3: КЛИЕНТ — КОММЕНТАРИИ И РЕАКЦИИ (4-5 ДНЕЙ)
**Цель: Добавить интерактивность к постам.**
1.  **Модель комментариев:** Реши, где хранить комментарии к посту. Варианты:
    *   **Вариант А (Простой):** Для каждого поста создаётся отдельный PubSub-узел `comments:post-<id>`. Комментарии — items в этом узле.
    *   **Вариант Б (Стандартный):** Использовать XEP-0277 (Microblog) с элементом `<comments>`.
2.  **Реализуй UI для поста (`PostComponent.vue`):**
    *   Отображает текст, автора, время.
    *   Кнопки «Комментировать», «Лайк».
    *   При нажатии «Комментировать» — открывается форма, которая публикует item в узел комментариев этого поста.
    *   Ниже поста — список комментариев, подгружаемый из соответствующего узла.

### ЭТАП 4: ГРУППЫ (MUC + PUBSUB) И ИНТЕГРАЦИЯ (4-5 ДНЕЙ)
1.  **Создание группы:** Реализуй интерфейс для создания MUC-комнаты, которая одновременно будет иметь связанный PubSub-узел для ленты группы.
2.  **Лента группы:** Пользователи, подписанные на группу (участники MUC), автоматически подписываются на её ленту-PubSub.
3.  **Сведение воедино:** Главная навигация клиента должна иметь вкладки: «Лента», «Уведомления», «Чаты», «Группы», «Профиль».

## УПРОЩЕНИЯ ДЛЯ MVP СОЦИАЛЬНОЙ СЕТИ
*   **Поиск и рекомендации:** Не реализовывать.
*   **Сложные медиа:** В постах — только текст и ссылки на изображения (через `mod_http_upload`).
*   **Сторисы:** Не реализовывать.
*   **Сложные настройки приватности:** В MVP у поста два состояния: виден подписчикам или нет.
*   **Уведомления в реальном времени:** Для MVP можно обойтись периодическим опросом (polling) PubSub-узлов.

## ЦЕЛЬ MVP (СОЦИАЛЬНАЯ СЕТЬ)
**Два пользователя на одном или доверенных серверах должны иметь возможность:**
1.  Зайти в клиент под своими JID.
2.  Подписаться друг на друга (добавить в контакты + подписаться на ленту).
3.  Опубликовать пост на своей стене.
4.  **Увидеть пост другого в своей общей ленте (`HomeFeed`).**
5.  Оставить комментарий под постом другого и видеть комментарии друг друга.
6.  Создать группу (сообщество), опубликовать в ней пост и видеть его как участники группы.

**Это будет MVP децентрализованной социальной сети на XMPP.**
